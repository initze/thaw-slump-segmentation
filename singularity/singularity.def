BootStrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu20.04
%help
   This Singularity definition contains a GPU-Nvidia, Gpu with PyTorch installation

%setup
   #export PACKAGES_TMP=/tmp/aicore
   #rm -fr $PACKAGES_TMP
   #mkdir -p $PACKAGES_TMP

%post
   DEBIAN_FRONTEND=noninteractive apt-get update && apt-get upgrade -y
   DEBIAN_FRONTEND=noninteractive apt-get install -y software-properties-common
   DEBIAN_FRONTEND=noninteractive add-apt-repository -y ppa:deadsnakes/ppa
   DEBIAN_FRONTEND=noninteractive apt-get update
   DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
   python3.11 \
   python3.11-dev \
   python3.11-distutils \
   python3.11-venv \
   wget \
   git \
   python3-opencv \
   nano

   # Install pip for Python 3.11 using get-pip.py
   wget https://bootstrap.pypa.io/get-pip.py
   python3.11 get-pip.py
   rm get-pip.py

   # Create and activate a virtual environment
   python3.11 -m venv /opt/venv
   . /opt/venv/bin/activate

   # Upgrade pip, setuptools, and wheel in the virtual environment
   python3.11 -m pip install --upgrade pip setuptools wheel

   #install gdal	
   apt-get update -y
   DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
		gdal-bin \
		python3-gdal \
		libgdal-dev

   # all the python packages you need:
   python3.11 -m pip install torch==2.2.0+cu118 torchvision==0.17.0+cu118 --index-url https://download.pytorch.org/whl/cu118
   python3.11 -m pip install nvidia-pyindex cuda-python
   python3.11 -m pip install git+https://github.com/initze/thaw-slump-segmentation.git@v0.10.6
   python3.11 -m pip install --extra-index-url=https://pypi.nvidia.com cucim-cu11==24.4.*

   # Deactivate the virtual environment
   deactivate


%environment
   alias python=python3.11
   export PATH="/opt/venv/bin:$PATH"

%runscript

%labels
   Author Ingmar Nitze, Celia Baumhoer